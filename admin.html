<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lekkilet - Admin Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="/image/new-removebg-preview.png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- ADD EMAILJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        // Initialize EmailJS
        (function() {
            emailjs.init("vRgGNPAWHSIJOJW2P");
            console.log('EmailJS initialized');
        })();
    </script>

    <style>
        body { font-family: 'Poppins', sans-serif; }
        .booking-pending { border-left: 4px solid #f59e0b; }
        .booking-confirmed { border-left: 4px solid #10b981; }
        .booking-expired { border-left: 4px solid #ef4444; }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            display: none;
            max-width: 400px;
        }
        .notification.success { background-color: #10b981; }
        .notification.error { background-color: #ef4444; }
        .notification.info { background-color: #3b82f6; }
        .login-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">üè† Lekkilet</h1>
                <p class="text-gray-600">Admin Panel Login</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="username" name="username" required 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" name="password" required 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <button type="submit" 
                        class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition font-medium">
                    Sign In
                </button>
            </form>
            
            <div class="mt-6 text-center text-sm text-gray-500">
                <!-- <p>Default credentials: admin / admin123</p> -->
                <!-- <p class="mt-2">Change these in production!</p> -->
            </div>
        </div>
    </div>

    <!-- Admin Panel (Hidden until login) -->
    <div id="adminPanel" class="hidden">
        <!-- Notification System -->
        <div id="notification" class="notification"></div>

        <!-- Email Confirmation Modal -->
        <div id="emailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-2xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Send Confirmation Email</h3>
                    <button onclick="closeEmailModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Client Name</label>
                            <input type="text" id="emailClientName" readonly class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Client Email</label>
                            <input type="email" id="emailClientEmail" readonly class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Apartment</label>
                            <input type="text" id="emailApartment" readonly class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nights</label>
                            <input type="text" id="emailNights" readonly class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email Subject</label>
                        <input type="text" id="emailSubject" value="Booking Confirmation - Lekkilet Apartments" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Confirmation Message</label>
                        <textarea id="emailMessage" rows="12" class="w-full p-2 border border-gray-300 rounded-lg">Dear {client_name},

We are pleased to inform you that your booking has been confirmed!

üìß Booking Details
- Apartment: {apartment_name}
- Check-in: {check_in}
- Check-out: {check_out}
- Nights: {nights} nights
- Guests: {guests}
- Total Amount: {total_amount}
- Booking ID: {booking_id}

üìç Location
{apartment_location}

üìû Contact Information
If you have any questions, please contact us:

Phone: +234 911 346 6296
Email: quicknestresidence@gmail.com

We look forward to hosting you!

Best regards,
Lekkilet Team</textarea>
                    </div>

                    <div class="flex space-x-2 pt-4">
                        <button onclick="sendConfirmationEmail()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 flex items-center flex-1 justify-center">
                            <i class="fas fa-paper-plane mr-2"></i> Send Confirmation Email
                        </button>
                        <button onclick="confirmWithoutEmail()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 flex items-center">
                            <i class="fas fa-check mr-2"></i> Confirm Only
                        </button>
                        <button onclick="closeEmailModal()" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="container mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-800">üè† Lekkilet Admin Panel</h1>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-600" id="userDisplay">Welcome, Admin</span>
                        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="container mx-auto px-4 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                <!-- Sidebar -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-sm p-6 sticky top-4">
                        <h3 class="font-semibold text-lg mb-4">Quick Actions</h3>
                        <div class="space-y-2">
                            <button onclick="showSection('pending')" class="w-full text-left p-3 rounded-lg hover:bg-gray-100 transition">
                                üìã Pending Bookings
                            </button>
                            <button onclick="showSection('confirmed')" class="w-full text-left p-3 rounded-lg hover:bg-gray-100 transition">
                                ‚úÖ Confirmed Bookings
                            </button>
                            <button onclick="showSection('calendar')" class="w-full text-left p-3 rounded-lg hover:bg-gray-100 transition">
                                üìÖ Calendar View
                            </button>
                            <button onclick="showSection('apartments')" class="w-full text-left p-3 rounded-lg hover:bg-gray-100 transition">
                                üè¢ Manage Apartments
                            </button>
                        </div>
                        
                        <div class="mt-6 p-4 bg-yellow-50 rounded-lg">
                            <h4 class="font-semibold text-sm mb-2">Stats</h4>
                            <div class="space-y-1 text-sm">
                                <div class="flex justify-between">
                                    <span>Pending:</span>
                                    <span id="pendingCount">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Confirmed:</span>
                                    <span id="confirmedCount">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Today:</span>
                                    <span id="todayCount">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="lg:col-span-3">
                    <!-- Pending Bookings Section -->
                    <div id="pendingSection" class="section">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Pending Bookings</h2>
                            <div class="flex space-x-2">
                                <button onclick="refreshData()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                                    üîÑ Refresh
                                </button>
                            </div>
                        </div>

                        <div id="pendingBookingsList" class="space-y-4">
                            <!-- Bookings will be loaded here -->
                        </div>
                    </div>

                    <!-- Confirmed Bookings Section -->
                    <div id="confirmedSection" class="section hidden">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Confirmed Bookings</h2>
                        <div id="confirmedBookingsList" class="space-y-4">
                            <!-- Confirmed bookings will be loaded here -->
                        </div>
                    </div>

                    <!-- Calendar View Section -->
                    <div id="calendarSection" class="section hidden">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Booking Calendar</h2>
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div id="bookingCalendar" class="grid grid-cols-7 gap-2">
                                <!-- Calendar will be generated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Apartments Management Section -->
                    <div id="apartmentsSection" class="section hidden">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Manage Apartments</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Apartment cards will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Booking Details Modal -->
        <div id="bookingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-2xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold" id="modalTitle">Booking Details</h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="modalContent">
                    <!-- Modal content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Login and Authentication System
        const ADMIN_CREDENTIALS = {
            username: 'admin',
            password: 'admin123'
        };

        // Check if user is already logged in
        document.addEventListener('DOMContentLoaded', function() {
            const isLoggedIn = localStorage.getItem('lekkiletAdminLoggedIn');
            const username = localStorage.getItem('lekkiletAdminUsername');
            
            if (isLoggedIn === 'true' && username) {
                showAdminPanel(username);
            }
            
            // Set up login form handler
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        });

        // Handle login form submission
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Simple authentication (replace with secure backend in production)
            if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                // Store login state
                localStorage.setItem('lekkiletAdminLoggedIn', 'true');
                localStorage.setItem('lekkiletAdminUsername', username);
                
                // Show admin panel
                showAdminPanel(username);
            } else {
                alert('Invalid credentials. Please try again.');
            }
        }

        // Show admin panel and hide login
        function showAdminPanel(username) {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            document.getElementById('userDisplay').textContent = `Welcome, ${username}`;
            
            // Load admin data
            loadBookings();
            showSection('pending');
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('lekkiletAdminLoggedIn');
                localStorage.removeItem('lekkiletAdminUsername');
                
                document.getElementById('adminPanel').classList.add('hidden');
                document.getElementById('loginPage').classList.remove('hidden');
                
                // Clear form
                document.getElementById('loginForm').reset();
            }
        }

        // Admin JavaScript
        let allBookings = [];
        let currentBookingId = null;

        // Load data on page load
        function loadBookings() {
            const saved = localStorage.getItem('lekkiletBookedDates');
            if (saved) {
                const data = JSON.parse(saved);
                allBookings = Object.values(data.pendingBookings || {});
                updateStats();
                renderPendingBookings();
                renderConfirmedBookings();
            }
        }

        // Update statistics
        function updateStats() {
            const pending = allBookings.filter(b => b.status === 'pending').length;
            const confirmed = allBookings.filter(b => b.status === 'confirmed').length;
            const today = allBookings.filter(b => {
                const today = new Date().toDateString();
                const bookingDate = new Date(b.createdAt).toDateString();
                return bookingDate === today;
            }).length;

            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('confirmedCount').textContent = confirmed;
            document.getElementById('todayCount').textContent = today;
        }

        // Show different sections
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show selected section
            document.getElementById(sectionName + 'Section').classList.remove('hidden');
        }

        // Render pending bookings
        function renderPendingBookings() {
            const container = document.getElementById('pendingBookingsList');
            const pendingBookings = allBookings.filter(b => b.status === 'pending');
            
            if (pendingBookings.length === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow-sm p-8 text-center">
                        <i class="fas fa-inbox text-4xl text-gray-300 mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-600">No Pending Bookings</h3>
                        <p class="text-gray-500">All bookings are processed.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = pendingBookings.map(booking => `
                <div class="booking-pending bg-white rounded-lg shadow-sm p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-semibold text-lg">${booking.userData.userName}</h3>
                            <p class="text-gray-600">${booking.userData.userPhone}</p>
                            <p class="text-gray-600">${booking.userData.userEmail || 'No email'}</p>
                        </div>
                        <div class="text-right">
                            <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-sm">Pending</span>
                            <p class="text-sm text-gray-500 mt-1">${formatTime(booking.createdAt)}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <p class="text-sm text-gray-600">Apartment</p>
                            <p class="font-medium">${booking.apartmentId}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Dates</p>
                            <p class="font-medium">${formatDate(new Date(booking.bookingData.checkIn))} - ${formatDate(new Date(booking.bookingData.checkOut))}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Nights</p>
                            <p class="font-medium">${booking.dates.length} nights</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Guests</p>
                            <p class="font-medium">${booking.bookingData.guests}</p>
                        </div>
                    </div>

                    <div class="flex space-x-2">
                        <button onclick="openEmailModal('${booking.id}')" 
                                class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 flex items-center">
                            <i class="fas fa-check mr-2"></i> Confirm
                        </button>
                        <button onclick="viewBookingDetails('${booking.id}')" 
                                class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center">
                            <i class="fas fa-eye mr-2"></i> Details
                        </button>
                        <button onclick="rejectBooking('${booking.id}')" 
                                class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 flex items-center">
                            <i class="fas fa-times mr-2"></i> Reject
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Render confirmed bookings
        function renderConfirmedBookings() {
            const container = document.getElementById('confirmedBookingsList');
            const confirmedBookings = allBookings.filter(b => b.status === 'confirmed');
            
            if (confirmedBookings.length === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow-sm p-8 text-center">
                        <i class="fas fa-calendar-check text-4xl text-gray-300 mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-600">No Confirmed Bookings</h3>
                        <p class="text-gray-500">Confirmed bookings will appear here.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = confirmedBookings.map(booking => `
                <div class="booking-confirmed bg-white rounded-lg shadow-sm p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-semibold text-lg">${booking.userData.userName}</h3>
                            <p class="text-gray-600">${booking.userData.userPhone}</p>
                        </div>
                        <div class="text-right">
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm">Confirmed</span>
                            <p class="text-sm text-gray-500 mt-1">${formatTime(booking.createdAt)}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600">Dates</p>
                            <p class="font-medium">${formatDate(new Date(booking.bookingData.checkIn))} - ${formatDate(new Date(booking.bookingData.checkOut))}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Apartment</p>
                            <p class="font-medium">${booking.apartmentId}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Open email confirmation modal
        function openEmailModal(bookingId) {
            const booking = allBookings.find(b => b.id === bookingId);
            if (booking && booking.userData.userEmail) {
                currentBookingId = bookingId;
                
                // Fill email form with booking data
                document.getElementById('emailClientName').value = booking.userData.userName;
                document.getElementById('emailClientEmail').value = booking.userData.userEmail;
                document.getElementById('emailApartment').value = booking.apartmentId;
                document.getElementById('emailNights').value = `${booking.dates.length} nights`;
                
                // Customize message with booking details - USE RAW DATES
                let message = document.getElementById('emailMessage').value;
                message = message.replace('{client_name}', booking.userData.userName);
                message = message.replace('{apartment_name}', booking.apartmentId);
                message = message.replace('{nights}', `${booking.dates.length} nights`);
                message = message.replace('{check_in}', formatDateForEmail(booking.bookingData.checkIn));
                message = message.replace('{check_out}', formatDateForEmail(booking.bookingData.checkOut));
                message = message.replace('{guests}', booking.bookingData.guests);
                document.getElementById('emailMessage').value = message;
                
                document.getElementById('emailModal').classList.remove('hidden');
            } else {
                // If no email, confirm directly
                confirmBookingDirect(bookingId);
            }
        }

        // Close email modal
        function closeEmailModal() {
            document.getElementById('emailModal').classList.add('hidden');
            currentBookingId = null;
        }

        function sendConfirmationEmail() {
            if (!currentBookingId) return;
            
            const booking = allBookings.find(b => b.id === currentBookingId);
            
            if (!booking.userData.userEmail || booking.userData.userEmail === 'No email') {
                showNotification('No email address provided by client.', 'error');
                return;
            }
            
            const subject = document.getElementById('emailSubject').value;
            
            // Show sending notification
            showNotification('Sending confirmation email...', 'info');
            
            // Disable buttons to prevent multiple clicks
            const sendBtn = document.querySelector('button[onclick="sendConfirmationEmail()"]');
            const confirmBtn = document.querySelector('button[onclick="confirmWithoutEmail()"]');
            sendBtn.disabled = true;
            confirmBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Sending...';
            
            // Use real email service with NEW template
            sendRealConfirmationEmail(booking.userData.userEmail, subject, "", booking)
                .then(() => {
                    // Confirm booking after email is sent
                    confirmBookingDirect(currentBookingId);
                    showNotification('Confirmation email sent successfully! Booking confirmed.', 'success');
                    closeEmailModal();
                })
                .catch(error => {
                    // Offer choice: confirm without email or try again
                    sendBtn.disabled = false;
                    confirmBtn.disabled = false;
                    sendBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> Send Confirmation Email';
                    
                    if (confirm('Email failed to send. Do you want to confirm the booking anyway and contact the client manually?')) {
                        confirmBookingDirect(currentBookingId);
                        showNotification('Booking confirmed. Please contact client manually.', 'info');
                        closeEmailModal();
                    } else {
                        showNotification('Email failed. Please try again or contact client manually.', 'error');
                    }
                });
        }

        // REAL Email sending function for CLIENT confirmations - FIXED DATE ISSUE
        function sendRealConfirmationEmail(clientEmail, subject, message, booking) {
            return new Promise((resolve, reject) => {
                // FIXED: Correct apartment names mapping
                const apartmentNames = {
                    'quicknest-apartment-1': 'QuickNest Apartment 1',
                    'quicknest-apartment-2': 'QuickNest Apartment 2',
                    'fifth-nest-apartment-1': 'Fifth Nest Apartment 1', 
                    'fifth-nest-apartment-2': 'Fifth Nest Apartment 2'
                };
                
                const apartmentLocations = {
                    'quicknest-apartment-1': '5 Kola Motajo Cl ilasan, Ikate Lekki 106104, Lagos, Nigeria',
                    'quicknest-apartment-2': '5 Kola Motajo Cl ilasan, Ikate Lekki 106104, Lagos, Nigeria',
                    'fifth-nest-apartment-1': 'Fifth Nest Location, Lagos, Nigeria',
                    'fifth-nest-apartment-2': 'Fifth Nest Location, Lagos, Nigeria'
                };
                
                const apartmentName = apartmentNames[booking.apartmentId] || booking.apartmentId;
                const apartmentLocation = apartmentLocations[booking.apartmentId] || 'Lagos, Nigeria';
                const totalAmount = (booking.dates.length * 160000 + 100000).toLocaleString();

                // FIXED: Use the raw date strings directly to avoid timezone issues
                const templateParams = {
                    to_email: clientEmail,
                    to_name: booking.userData.userName,
                    client_name: booking.userData.userName,
                    apartment_name: apartmentName,
                    apartment_location: apartmentLocation,
                    check_in: formatDateForEmail(booking.bookingData.checkIn), // Use raw date string
                    check_out: formatDateForEmail(booking.bookingData.checkOut), // Use raw date string
                    nights: booking.dates.length,
                    guests: booking.bookingData.guests,
                    total_amount: `‚Ç¶${totalAmount}`,
                    booking_id: booking.id
                };

                console.log('DEBUG - Original dates:', {
                    rawCheckIn: booking.bookingData.checkIn,
                    rawCheckOut: booking.bookingData.checkOut,
                    formattedCheckIn: templateParams.check_in,
                    formattedCheckOut: templateParams.check_out
                });

                console.log('Sending confirmation email TO CLIENT:', clientEmail);

                // Use your NEW template ID for client confirmations
                emailjs.send(
                    'service_qby0rem',           // Your EmailJS service ID
                    'template_b5sb7sy',          // Your NEW client confirmation template ID
                    templateParams
                )
                .then((response) => {
                    console.log('Client confirmation email sent successfully to:', clientEmail);
                    resolve(response);
                })
                .catch((error) => {
                    console.error('Client email failed to send to:', clientEmail, error);
                    reject(error);
                });
            });
        }

        // NEW: Safe date formatting function that preserves the original date
        function formatDateForEmail(dateString) {
            // If it's already in a readable format, use it directly
            if (dateString.includes(',') || dateString.includes('/')) {
                return dateString;
            }
            
            // If it's in ISO format (YYYY-MM-DD), parse it safely
            if (dateString.includes('-')) {
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    const year = parts[0];
                    const month = parts[1];
                    const day = parts[2];
                    
                    // Create date in UTC to avoid timezone shifts
                    const date = new Date(Date.UTC(year, month - 1, day));
                    return date.toLocaleDateString('en-US', {
                        timeZone: 'UTC', // Use UTC to preserve the exact date
                        weekday: 'short',
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                }
            }
            
            // Fallback: return the original string
            return dateString;
        }

        // Confirm without sending email
        function confirmWithoutEmail() {
            if (!currentBookingId) return;
            confirmBookingDirect(currentBookingId);
            showNotification('Booking confirmed successfully!', 'success');
            closeEmailModal();
        }

        // Confirm booking directly (original functionality + email integration)
        function confirmBookingDirect(bookingId) {
            const saved = localStorage.getItem('lekkiletBookedDates');
            if (saved) {
                const data = JSON.parse(saved);
                
                if (data.pendingBookings[bookingId]) {
                    const booking = data.pendingBookings[bookingId];
                    
                    // Update booking status to confirmed
                    data.pendingBookings[bookingId].status = 'confirmed';
                    
                    // Update dates status in apartment bookings
                    const apartmentBookings = data[booking.apartmentId] || [];
                    apartmentBookings.forEach(apartmentBooking => {
                        if (apartmentBooking.bookingId === bookingId) {
                            apartmentBooking.status = 'confirmed';
                        }
                    });
                    
                    // Save back to localStorage
                    localStorage.setItem('lekkiletBookedDates', JSON.stringify(data));
                    
                    // Reload data
                    loadBookings();
                }
            }
        }

        // Show notification
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        // Reject booking
        function rejectBooking(bookingId) {
            if (confirm('Are you sure you want to reject this booking?')) {
                const saved = localStorage.getItem('lekkiletBookedDates');
                if (saved) {
                    const data = JSON.parse(saved);
                    
                    // Remove from pending bookings
                    delete data.pendingBookings[bookingId];
                    
                    // Remove dates from apartment bookings
                    const booking = allBookings.find(b => b.id === bookingId);
                    if (booking) {
                        data[booking.apartmentId] = data[booking.apartmentId].filter(
                            b => b.bookingId !== bookingId
                        );
                    }
                    
                    localStorage.setItem('lekkiletBookedDates', JSON.stringify(data));
                    showNotification('Booking rejected successfully!', 'success');
                    loadBookings(); // Reload data
                }
            }
        }

        // View booking details
        function viewBookingDetails(bookingId) {
            const booking = allBookings.find(b => b.id === bookingId);
            if (booking) {
                document.getElementById('modalTitle').textContent = 'Booking Details';
                document.getElementById('modalContent').innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-2">Customer Information</h4>
                            <p><strong>Name:</strong> ${booking.userData.userName}</p>
                            <p><strong>Phone:</strong> ${booking.userData.userPhone}</p>
                            <p><strong>Email:</strong> ${booking.userData.userEmail || 'Not provided'}</p>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold mb-2">Booking Details</h4>
                            <p><strong>Apartment:</strong> ${booking.apartmentId}</p>
                            <p><strong>Check-in:</strong> ${formatDate(new Date(booking.bookingData.checkIn))}</p>
                            <p><strong>Check-out:</strong> ${formatDate(new Date(booking.bookingData.checkOut))}</p>
                            <p><strong>Nights:</strong> ${booking.dates.length}</p>
                            <p><strong>Guests:</strong> ${booking.bookingData.guests}</p>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold mb-2">Booking Status</h4>
                            <p><strong>Status:</strong> ${booking.status}</p>
                            <p><strong>Created:</strong> ${formatTime(booking.createdAt)}</p>
                            <p><strong>Booking ID:</strong> ${booking.id}</p>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex space-x-2">
                        ${booking.status === 'pending' ? `
                            <button onclick="openEmailModal('${booking.id}')" 
                                    class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                                Confirm Booking
                            </button>
                        ` : ''}
                        <button onclick="closeModal()" 
                                class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                            Close
                        </button>
                    </div>
                `;
                document.getElementById('bookingModal').classList.remove('hidden');
            }
        }

        // Utility functions - FIXED DATE FORMATTING
        function formatDate(date) {
            // Handle both Date objects and date strings
            const dateObj = typeof date === 'string' ? new Date(date) : date;
            
            return dateObj.toLocaleDateString('en-US', {
                timeZone: 'Africa/Lagos', // Use Lagos timezone
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatTime(dateString) {
            return new Date(dateString).toLocaleString('en-US', {
                timeZone: 'Africa/Lagos'
            });
        }

        function closeModal() {
            document.getElementById('bookingModal').classList.add('hidden');
        }

        function refreshData() {
            loadBookings();
            showNotification('Data refreshed!', 'info');
        }
    </script>
</body>
</html>